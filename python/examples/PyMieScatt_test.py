import meep as mp
from meep.materials import Al
import numpy as np
import numpy.linalg as la
import matplotlib.pyplot as plt
import PyMieScatt as ps


r = 1.0

freqs = [0.31830988618379075, 0.33117089168616615, 0.3440318971885415, 0.3568929026909169, 0.36975390819329224,
         0.38261491369566764, 0.39547591919804304, 0.4083369247004184, 0.4211979302027938, 0.4340589357051692,
         0.4469199412075445, 0.4597809467099199, 0.4726419522122953, 0.48550295771467067, 0.49836396321704607,
         0.5112249687194215, 0.5240859742217968, 0.5369469797241722, 0.5498079852265476, 0.562668990728923,
         0.5755299962312983, 0.5883910017336738, 0.6012520072360491, 0.6141130127384244, 0.6269740182407999,
         0.6398350237431752, 0.6526960292455506, 0.665557034747926, 0.6784180402503014, 0.6912790457526767,
         0.7041400512550522, 0.7170010567574274, 0.7298620622598029, 0.7427230677621783, 0.7555840732645536,
         0.768445078766929, 0.7813060842693044, 0.7941670897716797, 0.8070280952740552, 0.8198891007764305,
         0.8327501062788059, 0.8456111117811813, 0.8584721172835567, 0.871333122785932, 0.8841941282883075,
         0.8970551337906828, 0.9099161392930581, 0.9227771447954336, 0.935638150297809, 0.9484991558001843,
         0.9613601613025597, 0.9742211668049351, 0.9870821723073104, 0.9999431778096859, 1.0128041833120611,
         1.0256651888144366, 1.038526194316812, 1.0513871998191875, 1.0642482053215627, 1.077109210823938,
         1.0899702163263134, 1.1028312218286889, 1.1156922273310643, 1.1285532328334398, 1.141414238335815,
         1.1542752438381902, 1.1671362493405657, 1.1799972548429412, 1.1928582603453166, 1.205719265847692,
         1.2185802713500673, 1.2314412768524425, 1.244302282354818, 1.2571632878571934, 1.270024293359569,
         1.2828852988619441, 1.2957463043643196, 1.3086073098666948, 1.3214683153690703, 1.3343293208714457,
         1.347190326373821, 1.3600513318761964, 1.3729123373785719, 1.3857733428809471, 1.3986343483833226,
         1.411495353885698, 1.4243563593880733, 1.4372173648904487, 1.4500783703928242, 1.4629393758951994,
         1.4758003813975749, 1.4886613868999503, 1.5015223924023255, 1.514383397904701, 1.5272444034070765,
         1.5401054089094517, 1.5529664144118271, 1.5658274199142026, 1.5786884254165778, 1.5915494309189533]

calculated_indices = [np.sqrt(la.det(Al.epsilon(f))) for f in freqs]
print(calculated_indices)

indices =  [4.8033+31.109j, 4.5304+30.004j, 4.2775+28.969j, 4.0428+28.009j, 3.8274+27.106j, 3.6292+26.256j,
            3.4438+25.461j, 3.2730+24.705j, 3.1168+23.977j, 2.9698+23.293j, 2.8313+22.647j, 2.7006+22.038j,
            2.5769+21.462j, 2.4613+20.914j, 2.3617+20.376j, 2.2670+19.864j, 2.1771+19.378j, 2.0914+18.915j,
            2.0097+18.473j, 1.9318+18.052j, 1.8684+17.636j, 1.8097+17.235j, 1.7535+16.852j, 1.6997+16.485j,
            1.6480+16.132j, 1.5985+15.794j, 1.5589+15.464j, 1.5265+15.142j, 1.4953+14.832j, 1.4653+14.534j,
            1.4365+14.247j, 1.4086+13.970j, 1.3859+13.700j, 1.3731+13.435j, 1.3607+13.179j, 1.3488+12.932j,
            1.3373+12.692j, 1.3261+12.460j, 1.3158+12.236j, 1.3179+12.016j, 1.3200+11.803j, 1.3220+11.597j,
            1.3239+11.396j, 1.3258+11.202j, 1.3277+11.013j, 1.3375+10.827j, 1.3496+10.647j, 1.3613+10.471j,
            1.3726+10.300j, 1.3837+10.134j, 1.3945+9.9717j, 1.4071+9.8110j, 1.4216+9.6515j, 1.4357+9.4960j,
            1.4563+9.3222j, 1.4764+9.1525j, 1.5241+8.9741j, 1.6010+8.7861j, 1.6761+8.6026j, 1.7947+8.4824j,
            1.9119+8.3669j, 2.0315+8.2696j, 2.1545+8.1924j, 2.2746+8.1169j, 2.3625+8.1282j, 2.4469+8.1433j,
            2.5296+8.1582j, 2.6104+8.1727j, 2.6895+8.1869j, 2.7219+8.2141j, 2.7506+8.2417j, 2.7669+8.2798j,
            2.7672+8.3317j, 2.7675+8.3825j, 2.7109+8.4256j, 2.6505+8.4672j, 2.5839+8.4821j, 2.5083+8.4596j,
            2.4341+8.4376j, 2.3613+8.4160j, 2.2899+8.3949j, 2.2199+8.3741j, 2.1529+8.3496j, 2.0978+8.3002j,
            2.0436+8.2516j, 1.9905+8.2039j, 1.9383+8.1571j, 1.8870+8.1112j, 1.8367+8.0660j, 1.7931+8.0134j,
            1.7511+7.9605j, 1.7098+7.9085j, 1.6693+7.8574j, 1.6294+7.8072j, 1.5902+7.7578j, 1.5536+7.7053j,
            1.5193+7.6504j, 1.4855+7.5964j, 1.4523+7.5432j, 1.4196+7.4909j]


n_sphere = 2.0
scatt_eff_theory = [ps.MieQ(calculated_indices[i], 1000/freqs[i], 2*r*1000, asDict=True)['Qsca'] for i in range(len(freqs))]

if mp.am_master():
    plt.figure(dpi=150)
    #plt.loglog(2*np.pi*r*np.asarray(freqs),abs_eff_meep,'bo-',label='Meep')
    plt.loglog(2*np.pi*r*np.asarray(freqs),scatt_eff_theory,'ro-',label='theory')
    plt.grid(True,which="both",ls="-")
    plt.xlabel('(sphere circumference)/wavelength, 2πr/λ')
    plt.ylabel('scattering efficiency, σ/πr$^{2}$')
    plt.legend(loc='upper right')
    plt.title('Mie Scattering of a Lossy Dielectric (Aluminum) Sphere')
    plt.tight_layout()
    #plt.savefig("mie_scattering_lossy.png")
    plt.show()